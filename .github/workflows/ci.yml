name: CI

on:
  push:
    branches: [ developer ]
  pull_request:
    branches: [ main, developer ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fix script permissions
        run: chmod +x tests/*.sh

      - name: Compose up (build)
        run: |
          docker compose up -d --build
          docker compose ps
          # aguarda serviços principais aparecerem
          for i in {1..40}; do
            UP=$(docker ps --format '{{.Names}} {{.Status}}' | grep -c -E 'app1-flask|app2-express|prometheus|grafana|proxy-nginx')
            [ "$UP" -ge 5 ] && break || sleep 5
          done

      - name: Wait for app health (simple retry)
        run: |
          set -e
          # espera o proxy ficar saudável
          for i in {1..50}; do
            curl -fsS http://127.0.0.1:18080/healthz && break || sleep 2
          done
          # valida apps via proxy (fluxo real)
          curl -fsS http://127.0.0.1:18080/app1/hello
          curl -fsS http://127.0.0.1:18080/app2/hello

      - name: Smoke via proxy
        env:
          RETRIES: 60
          SLEEP_SECS: 2
        run: ./tests/smoke.sh

      - name: Scrape check (Prometheus targets)
        run: |
          curl -fsS http://127.0.0.1:19090/targets | head -n 50

      - name: Collect logs
        if: always()
        run: |
          mkdir -p artifacts
          docker compose logs --no-color > artifacts/compose-logs.txt || true
          docker ps > artifacts/ps.txt || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: artifacts/

      - name: Compose down
        if: always()
        run: docker compose down -v
